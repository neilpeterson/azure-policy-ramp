trigger:
  branches:
    include:
    - main
  paths:
    include:
      - azure-pipelines-nepeters.yml

stages:
  - stage: Build
    dependsOn: []

    jobs:
      - job: ConfigPackaging
        displayName: Configuration Package Creation
        pool: 
          vmImage: windows-2022
          
        variables:
          Parameters.outputStorageUri: ''
          Parameters.outputStorageToken: ''

        steps:
          - task: PowerShell@2
            displayName: Setting Modules and Compiling
            inputs:
              pwsh: true
              targetType: 'inline'
              script: |
                find-module PSDesiredStateConfiguration | install-module -Force
                find-module PSDSCResources | install-module -Force
                find-module GuestConfiguration | install-module -Force
                find-module SChannelDsc | install-module -Force
                
                .\tls-config\tls.ps1

                New-GuestConfigurationPackage -Name 'tls' -Configuration './tls/localhost.mof' -Type AuditAndSet -Force
          
          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: .\tls.zip
              artifactName: tls

  - stage: DeployTest
    dependsOn: Build
    jobs:
      - job: PolicyCreation
        displayName: Azure Policy Implementation
        pool: 
          vmImage: windows-2022
        
        steps:
        - task: DownloadPipelineArtifact@2
          inputs:
            buildType: 'current'
            artifactName: 'tls'
            targetPath: '.\'

        - task: AzureFileCopy@3
          inputs:
            SourcePath: '.\tls.zip'
            azureSubscription: 'nepeters-arm-connection'
            Destination: 'AzureBlob'
            storage: 'azurepolicycdef'
            ContainerName: 'guestconfiguration'
            outputStorageUri: Parameters.outputStorageUri
            outputStorageContainerSasToken: Parameters.outputStorageToken
            sasTokenTimeOutInMinutes: '525600'        
        
        - task: PowerShell@2
          displayName: Creating Policy
          inputs:
            pwsh: true
            targetType: 'inline'
            script: |
              find-module PSDesiredStateConfiguration | install-module -Force
              find-module PSDSCResources | install-module -Force
              find-module GuestConfiguration | install-module -Force
              find-module SChannelDsc | install-module -Force
                
              $ContentURI = "$(Parameters.outputStorageUri)tls.zip$(Parameters.outputStorageToken)"
                
              New-GuestConfigurationPolicy -PolicyId (New-Guid).Guid -ContentUri $ContentURI -DisplayName 'tls' -Path './policies' -Platform 'Windows' -Description 'tls' -PolicyVersion 1.0.0 -Mode ApplyAndAutoCorrect -Verbose

              $RawPolicy = Get-Content .\policies\tls_DeployIfNotExists.json -raw
              $PolicyObj = ConvertFrom-Json $RawPolicy

              $PolicyObj.properties.policyRule.then.details.deployment.properties.parameters.assignmentName.value = "tls"
              $PolicyObj.properties.policyRule.then.details.name = "tls"
              $Out = ConvertTo-Json -InputObject $PolicyObj -depth 32
              Set-Content -Path .\policies\tls_DeployIfNotExists.json -Value $Out
          
        - task: AzurePowerShell@5
          displayName: Create Assignment and Remediation
          inputs:
            azureSubscription: 'nepeters-arm-connection'
            ScriptType: 'InlineScript'
            azurePowerShellVersion: 'LatestVersion'
            Inline: |
            
              $Policy = New-AzPolicyDefinition -Name 'tls' -Policy .\policies\tls_DeployIfNotExists.json

              $policyDef = Get-AzPolicyDefinition -Id $Policy.PolicyDefinitionId
              $resourceGroup = Get-AzResourceGroup -Name 'test-001'
              $resourceGroup.ResourceId
              $assignment = New-AzPolicyAssignment -Name 'tls' -DisplayName 'tls' -Scope $resourceGroup.ResourceId -PolicyDefinition $policyDef -Location 'centralus' -IdentityType "UserAssigned" -IdentityId '268ab7ad-035d-4194-9ebe-81efde9a3d40'

              # # Use the $policyDef to get to the roleDefinitionIds array
              # $roleDefinitionIds = $policyDef.Properties.policyRule.then.details.roleDefinitionIds

              # if ($roleDefinitionIds.Count -gt 0)
              # {
              #     $roleDefinitionIds | ForEach-Object {
              #         $roleDefId = $_.Split("/") | Select-Object -Last 1
              #         New-AzRoleAssignment -Scope $resourceGroup.ResourceId -ObjectId $assignment.Identity.PrincipalId -RoleDefinitionId $roleDefId
              #     }
              # }


              Start-Sleep -Seconds 60
              Start-AzPolicyRemediation -Name 'myRemedation' -PolicyAssignmentId $assignment.PolicyAssignmentId -ResourceGroupName test-001