trigger: 
  - main

stages:
  - stage: Build
    dependsOn: []

    jobs:
      - job: ConfigPackaging
        displayName: Configuration Package Creation
        pool: 
          vmImage: windows-2022
          
        variables:
          Parameters.outputStorageUri: ''

        steps:

          - task: AzurePowerShell@5
            inputs:
              azureSubscription: 'shivam-arm-connection'
              ScriptType: 'InlineScript'
              Inline: 'Get-AzResourceGroup'
              azurePowerShellVersion: 'LatestVersion'

          - task: PowerShell@2
            displayName: Setting Modules and Compiling
            inputs:
              pwsh: true
              targetType: 'inline'
              script: |
                find-module PSDesiredStateConfiguration | install-module -Force
                find-module PSDSCResources | install-module -Force
                find-module GuestConfiguration | install-module -Force
                find-module SChannelDsc | install-module -Force
                
                .\tls-config\tls.ps1
                
                dir

                dir tls

                New-GuestConfigurationPackage -Name 'tls-secure' -Configuration './tls/localhost.mof' -Type AuditAndSet -Force
          - task: AzureFileCopy@3
            inputs:
              SourcePath: '.\tls-secure.zip'
              azureSubscription: 'shivam-arm-connection'
              Destination: 'AzureBlob'
              storage: 'azurepolicyabcd'
              ContainerName: 'guestconfiguration'
              outputStorageUri: Parameters.outputStorageUri
              sasTokenTimeOutInMinutes: '525600'
          
          - task: PowerShell@2
            displayName: Creating Policy
            inputs:
              pwsh: true
              targetType: 'inline'
              script: |
                $(Parameters.outputStorageUri)


              